<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Kartu Tanda Anggota HIMA-STI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <style>
      .kta-card {
        max-width: 350px;
        margin: 40px auto;
        padding: 24px;
        border: 2px solid #007bff;
        border-radius: 12px;
        background: #f8f9fa;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        text-align: center;
      }
      .kta-photo {
        width: 96px;
        height: 96px;
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid #007bff;
        margin-bottom: 12px;
        background: #fff;
      }
      .kta-info {
        margin-bottom: 8px;
        font-size: 1rem;
      }
      .kta-qr {
        margin: 16px auto 8px;
        width: 78px;
        height: 78px;
      }
      @media print {
        body * {
          visibility: hidden;
        }
        .kta-card,
        .kta-card * {
          visibility: visible;
        }
        .kta-card {
          box-shadow: none;
          border: none;
        }
        #btnPrint {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="kta-card">
      <img
        id="foto"
        class="kta-photo"
        src="assets/img/logo.png"
        alt="Foto Anggota"
      />
      <div id="nama" class="kta-info fw-bold">-</div>
      <div id="nim" class="kta-info">NIM: -</div>
      <div id="ttl" class="kta-info">TTL: -</div>
      <div id="angkatan" class="kta-info">Angkatan: -</div>
      <div id="divjab" class="kta-info">- • -</div>
      <div id="qr" class="kta-qr"></div>
      <div id="status" class="alert alert-info mt-2">Memuat data...</div>
      <button id="btnPrint" class="btn btn-primary mt-3">Cetak KTA</button>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script>
      function getQueryId() {
        const url = new URL(window.location.href);
        return url.searchParams.get("id");
      }

      async function loadKTA() {
        const user = requireAuth();
        const status = document.getElementById("status");

        const id = getQueryId() || user.memberId;
        if (!id) {
          status.className = "alert alert-danger";
          status.textContent =
            "memberId kosong. Isi kolom memberId di sheet users (isi id anggota dari sheet members).";
          return;
        }

        const res = await api("members", { id }, "GET", "&_method=GETONE");
        if (!res.ok) {
          status.className = "alert alert-danger";
          status.textContent = res.message || "Gagal memuat data KTA";
          return;
        }

        const m = res.data;
        document.getElementById("foto").src =
          m.fotoUrl || "assets/img/logo.png";
        document.getElementById("nama").textContent = m.nama || "-";
        document.getElementById("nim").textContent = `NIM: ${m.nim || "-"}`;
        document.getElementById("ttl").textContent = `TTL: ${m.ttl || "-"}`;
        document.getElementById("angkatan").textContent = `Angkatan: ${
          m.angkatan || "-"
        }`;
        document.getElementById("divjab").textContent = `${m.divisi || "-"} • ${
          m.jabatan || "-"
        }`;

        const qrText = `HIMA-STI|${m.id}|${m.nim}|${m.nama}`;
        document.getElementById("qr").innerHTML = "";
        new QRCode(document.getElementById("qr"), {
          text: qrText,
          width: 78,
          height: 78,
        });

        status.className = "alert alert-success";
        status.textContent = "Siap dicetak.";
      }

      document
        .getElementById("btnPrint")
        ?.addEventListener("click", () => window.print());
      document.addEventListener("DOMContentLoaded", loadKTA);
    </script>
  </body>
</html>
